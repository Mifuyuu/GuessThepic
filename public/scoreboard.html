<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- Include Socket.IO Client Library (served by the server) -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* --- Basic Reset & Body --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            /* min-height: 100vh; */
            padding: 20px;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }

        /* --- Main Container --- */
        #scoreboard-container {
            width: 100%;
            max-width: 600px;
            text-align: center;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-bottom: 25px;
            color: #1a237e;
            font-weight: 700;
        }

        /* --- Controls --- */
        #sort-controls {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 25px;
             gap: 15px;
        }

        #sort-controls label {
            font-weight: 500;
            color: #555;
        }

        #sort-by {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1rem;
            flex-grow: 1;
            background-color: #fff;
            cursor: pointer;
        }

        /* --- Leaderboard Area --- */
        #leaderboard {
            position: relative; /* Crucial for absolute positioning of rows */
            height: calc((var(--team-height, 55px) + var(--team-spacing, 8px)) * 10 + 55px); /* Adjust height based on row height/spacing + maybe one extra for user */
            width: 100%;
            margin-bottom: 20px;
            overflow: hidden; /* Clip rows animating outside */
        }

        /* --- Individual Scoreboard Row --- */
        :root {
            --team-height: 55px;
            --team-spacing: 8px;
        }

        .scoreboard-row {
            position: absolute; /* Needed for position animation */
            width: 100%;
            height: var(--team-height);
            background: var(--color, #607d8b); /* Default color, overridden by rank */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            left: 0;
            /* --- The Magic: Position based on --i and Animate 'top' --- */
            top: calc(var(--i, 0) * (var(--team-height) + var(--team-spacing)));
            transition: top 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55), /* Animate position */
                        opacity 300ms ease-out,                         /* Animate fade in/out */
                        background-color 300ms ease;                   /* Animate color change */
            /* --- End Magic --- */
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px;
            padding: 0 20px;
            color: #fff;
            font-weight: 500;
            opacity: 1; /* Default visible state */
        }

        /* Style for when a row is being removed (optional fade-out) */
        .scoreboard-row.removing {
            opacity: 0;
            /* Optionally move it out */
            /* transform: translateX(-100%); */
        }

        /* Style for user highlight */
        .scoreboard-row.user-highlight {
             /* border: 2px solid #ffeb3b; */
             outline: 3px solid #ffd700; /* Use outline instead of border */
             outline-offset: -2px; /* Adjust offset */
             box-shadow: 0 0 10px rgba(255, 235, 59, 0.6);
        }


        .scoreboard-row span:first-child { /* Rank + Username */
            font-size: 1.05rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
        }

        .scoreboard-row span:last-child { /* Score/Streak */
            font-size: 1.2rem;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        /* --- Status Messages (Loading/Error/Empty) --- */
        .status-message {
            position: absolute;
            top: 40%; /* Adjust vertical position */
            left: 50%;
            transform: translate(-50%, -50%);
            font-style: italic;
            color: #777;
            font-size: 1rem;
            padding: 20px;
            text-align: center;
            width: 80%; /* Ensure it doesn't get too wide */
        }
        .status-error { color: #e53935; }
        .status-warning { color: #f9a825; }
        .status-info { color: #555; }

        /* --- User Rank Display (Separate Div) --- */
        #user-rank {
            margin-top: 20px;
            font-weight: 600;
            background-color: #e8eaf6;
            color: #3f51b5;
            padding: 12px 18px;
            border-radius: 8px;
            border: 1px solid #c5cae9;
            text-align: center;
        }
        #user-rank-text { color: #1a237e; }

        /* --- Back Button --- */
        #back-to-game {
            margin-top: 25px;
            padding: 12px 25px;
            background: linear-gradient(45deg, #42a5f5, #1e88e5);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #back-to-game:hover {
            background: linear-gradient(45deg, #1e88e5, #1565c0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        #back-to-game:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* --- Rank Colors --- */
        .rank-1 { --color: #ffc107; color: #424242;} /* Gold */
        .rank-2 { --color: #e0e0e0; color: #424242;} /* Silver */
        .rank-3 { --color: #d8a477; } /* Bronze */
        .rank-4 { --color: #81c784; } /* Green */
        .rank-5 { --color: #64b5f6; } /* Blue */
        .rank-6 { --color: #ffb74d; } /* Orange */
        .rank-7 { --color: #e57373; } /* Red */
        .rank-8 { --color: #9575cd; } /* Purple */
        .rank-9 { --color: #78909c; } /* Blue Grey */
        .rank-10 { --color: #4dd0e1; } /* Cyan */
        .user-rank-outside { --color: #7e57c2; } /* Specific color for user outside top 10 */

    </style>
</head>
<body>
    <div id="scoreboard-container">
        <h1>Scoreboard</h1>

        <div id="sort-controls">
            <label for="sort-by">Sort By:</label>
            <select id="sort-by">
                <option value="score">Score</option>
                <option value="mostStreak">Highest Streak</option>
            </select>
        </div>

        <div id="leaderboard">
            <!-- Scoreboard rows will be dynamically added/updated here -->
            <p class="status-message" id="status-message" style="display:none;">Loading...</p>
        </div>

        <div id="user-rank" style="display:none;">
            <!-- User's rank text will be set here -->
        </div>

        <button id="back-to-game">Back to Game</button>
    </div>

    <script>
        // --- DOM Element References ---
        const sortBySelect = document.getElementById('sort-by');
        const leaderboardDiv = document.getElementById('leaderboard');
        const userRankDiv = document.getElementById('user-rank');
        const statusMessage = document.getElementById('status-message');
        const backToGameButton = document.getElementById('back-to-game');

        // --- State Variables ---
        let playerElements = new Map(); // Map: username -> { element: HTMLElement, data: Object }
        let currentUsername = sessionStorage.getItem('username');
        const token = localStorage.getItem('token');

        // --- Socket.IO Client Setup ---
        const socket = io({ /* auth: { token: token } // Optional: Add if server verifies sockets */ });

        socket.on('connect', () => {
            console.log('Socket.IO Connected:', socket.id);
        });

        socket.on('scoreUpdated', () => {
            console.log('Received "scoreUpdated" event. Fetching leaderboard...');
            fetchLeaderboard(sortBySelect.value); // Fetch using current sort order
        });

        socket.on('disconnect', (reason) => {
            console.warn('Socket.IO Disconnected. Reason:', reason);
            setStatusMessage('Real-time updates disconnected.', 'warning');
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO Connection Error:', error);
            setStatusMessage(`Connection error: ${error.message}. Real-time updates unavailable.`, 'error');
        });
        // --- End Socket.IO Setup ---

        // --- Helper Functions ---
        function setStatusMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`; // Set class for styling
            statusMessage.style.display = 'block';
            // Hide individual elements if showing a status message covering the area
             leaderboardDiv.querySelectorAll('.scoreboard-row').forEach(el => el.style.opacity = '0'); // Hide rows visually
             userRankDiv.style.display = 'none';
        }

        function formatRank(rank) {
            if (!rank) return '';
            if (rank === 1) return "1st";
            if (rank === 2) return "2nd";
            if (rank === 3) return "3rd";
            return `${rank}th`;
        }
        // --- End Helper Functions ---

        // --- Event Listeners ---
        backToGameButton.addEventListener('click', () => {
            window.location.href = 'game.html';
        });

        sortBySelect.addEventListener('change', () => {
            // Clear existing elements immediately for visual feedback before fetch completes
             // leaderboardDiv.innerHTML = ''; // Avoid this to keep transitions smooth
             // playerElements.clear(); // Clear the map if you prefer a full rebuild on sort change
            fetchLeaderboard(sortBySelect.value);
        });
        // --- End Event Listeners ---

        // --- Core Function: Fetch and Update Leaderboard ---
        async function fetchLeaderboard(sortBy = 'score') {
            if (!token || !currentUsername) {
                console.error('Auth missing. Redirecting.');
                window.location.href = 'index.html';
                return;
            }

            setStatusMessage('Loading leaderboard...', 'info');

            try {
                const response = await fetch(`/api/leaderboard?sortBy=${sortBy}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         console.error('Authentication error (401/403). Redirecting...');
                         localStorage.removeItem('token');
                         sessionStorage.removeItem('username');
                         setStatusMessage('Authentication failed. Please log in again.', 'error');
                         setTimeout(() => window.location.href = 'index.html', 3000);
                    } else {
                         setStatusMessage(`Error loading leaderboard: ${response.status} ${response.statusText}`, 'error');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                statusMessage.style.display = 'none'; // Hide loading message
                 leaderboardDiv.querySelectorAll('.scoreboard-row').forEach(el => el.style.opacity = '1'); // Ensure rows are visible again


                if (!data || !Array.isArray(data.leaderboard)) {
                    console.error("Invalid data format:", data);
                    setStatusMessage("Failed to process leaderboard data.", 'error');
                    return;
                }

                // --- DOM Update Logic with Animation ---
                const newLeaderboardData = data.leaderboard; // Top 10 (or less)
                const currentUserRankData = {
                     rank: data.userRank,
                     score: data.userScore,
                     mostStreak: data.userMostStreak
                };

                const newUsernamesInTop = new Set(newLeaderboardData.map(p => p.username));
                const nextPlayerElements = new Map(); // Build the next state map

                // 1. Update or Create elements for the Top list
                newLeaderboardData.forEach((playerData, index) => {
                    const username = playerData.username || 'Unknown';
                    const value = sortBy === 'score' ? (playerData.score ?? 0) : (playerData.mostStreak ?? 0);
                    const rank = index + 1;

                    let existingEntry = playerElements.get(username);
                    let playerDiv;

                    if (existingEntry) {
                        // --- UPDATE EXISTING ---
                        playerDiv = existingEntry.element;

                        // Update displayed data only if changed (optional optimization)
                        if (existingEntry.data.score !== playerData.score || existingEntry.data.mostStreak !== playerData.mostStreak || existingEntry.currentRank !== rank) {
                             const nameSpan = playerDiv.querySelector('span:first-child');
                             const valueSpan = playerDiv.querySelector('span:last-child');
                             if (nameSpan) nameSpan.textContent = `${rank}. ${username}`;
                             if (valueSpan) valueSpan.textContent = value;
                        }

                        // Update position via CSS variable (triggers animation)
                        playerDiv.style.setProperty('--i', index);

                        // Update rank class for styling
                        const newRankClass = `rank-${rank}`;
                        if (!playerDiv.classList.contains(newRankClass)) {
                            // Remove old rank classes before adding new one
                            playerDiv.className = playerDiv.className.replace(/rank-\d+/g, '').trim();
                            playerDiv.classList.add('scoreboard-row', newRankClass);
                        }

                        // Update highlight status
                        if (username === currentUsername) {
                            playerDiv.classList.add('user-highlight');
                        } else {
                            playerDiv.classList.remove('user-highlight');
                        }

                        playerElements.delete(username); // Mark as processed from old map

                    } else {
                        // --- CREATE NEW ---
                        playerDiv = document.createElement('div');
                        playerDiv.className = `scoreboard-row rank-${rank}`;
                         if (username === currentUsername) {
                            playerDiv.classList.add('user-highlight');
                         }
                        playerDiv.style.setProperty('--i', index);
                         // Initial state for entry animation (optional)
                         // playerDiv.style.opacity = '0';

                        playerDiv.innerHTML = `
                            <span>${rank}. ${username}</span>
                            <span>${value}</span>
                        `;
                        leaderboardDiv.appendChild(playerDiv);

                         // Trigger entry animation (optional)
                         // requestAnimationFrame(() => {
                         //    requestAnimationFrame(() => { playerDiv.style.opacity = '1'; });
                         // });
                    }

                    // Add to the next state map (both updated and new elements)
                     nextPlayerElements.set(username, { element: playerDiv, data: playerData, currentRank: rank });
                });

                // 2. Remove elements that are no longer in the Top list
                playerElements.forEach((entryToRemove, username) => {
                    console.log(`Removing element for ${username} (dropped off top list)`);
                    const element = entryToRemove.element;
                    element.classList.add('removing'); // Add class for potential exit animation

                    // Remove from DOM after animation (or immediately if no animation)
                    const transitionDuration = 500; // Match CSS transition duration
                    setTimeout(() => {
                         if (element.parentNode === leaderboardDiv) { // Check if still attached
                              leaderboardDiv.removeChild(element);
                         }
                    }, transitionDuration); // Use timeout slightly longer than transition
                });

                // 3. Update the main state map
                playerElements = nextPlayerElements;

                // 4. Update User Rank Display (separate div)
                 if (currentUserRankData.rank !== null && currentUserRankData.rank !== undefined) {
                     const userValue = sortBy === 'score' ? (currentUserRankData.score ?? 0) : (currentUserRankData.mostStreak ?? 0);
                     const rankString = formatRank(currentUserRankData.rank);
                     userRankDiv.innerHTML = `Your Rank: <span id="user-rank-text">${rankString} (${sortBy === 'score' ? 'Score' : 'Streak'}: ${userValue})</span>`;
                     userRankDiv.style.display = 'block';
                 } else {
                     userRankDiv.style.display = 'none'; // Hide if user has no rank
                 }

                 // 5. Handle the special row for user outside top 10
                 handleUserOutsideTop10(currentUserRankData, newUsernamesInTop, sortBy);


                // Handle empty state AFTER processing
                if (playerElements.size === 0 && !currentUserRankData.rank) {
                    setStatusMessage("No players on the leaderboard yet.", 'info');
                }

            } catch (error) {
                console.error('Error in fetchLeaderboard:', error);
                // Avoid showing error if auth redirect is happening
                if (!error.message.includes('Authentication failed')) {
                     setStatusMessage('Could not load leaderboard.', 'error');
                }
            }
        }

        // Helper function specifically for the user outside top 10 row
        function handleUserOutsideTop10(userData, topUsernames, sortBy) {
             const userRowOutsideId = 'user-rank-outside-row';
             let userRowOutside = document.getElementById(userRowOutsideId);
             const shouldShowOutside = userData.rank > 10 && !topUsernames.has(currentUsername);

             if (shouldShowOutside) {
                 const userValue = sortBy === 'score' ? (userData.score ?? 0) : (userData.mostStreak ?? 0);
                 const rankString = formatRank(userData.rank);

                 if (!userRowOutside) { // Create if doesn't exist
                     userRowOutside = document.createElement('div');
                     userRowOutside.id = userRowOutsideId;
                     userRowOutside.className = 'scoreboard-row user-rank-outside'; // Specific class
                     userRowOutside.style.setProperty('--i', 10); // Fixed position below top 10
                     leaderboardDiv.appendChild(userRowOutside);
                      // Entry animation?
                      // userRowOutside.style.opacity = '0';
                      // requestAnimationFrame(() => { userRowOutside.style.opacity = '1'; });
                 }
                 // Update content
                 userRowOutside.innerHTML = `
                      <span>${userData.rank}. ${currentUsername}</span>
                      <span>${userValue}</span>
                 `;

             } else if (userRowOutside) { // Remove if exists but shouldn't be shown
                  // Exit animation?
                  // userRowOutside.classList.add('removing');
                  // setTimeout(() => userRowOutside.remove(), 500);

                  // Simple remove:
                  userRowOutside.remove();
             }
        }


        // --- Initial Load ---
        window.addEventListener('load', () => {
            if (token && currentUsername) {
                fetchLeaderboard(sortBySelect.value); // Initial fetch
            } else {
                console.log('Auth missing on load. Redirecting.');
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>